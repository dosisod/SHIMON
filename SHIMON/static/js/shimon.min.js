var added_at=0;const api_wait=5e3;async function post(e,r=!1){error(!1);var t=document.cookie.replace(/(?:(?:^|.*;\s*)session\s*\=\s*([^;]*).*$)|^.*$/,"$1");t&&(e.session=t),e.redirect=!!r;var o=e=>{if("object"==typeof e)try{return JSON.stringify(e)}catch{}return e};if(!r){var n=new FormData;for(var a in e)n.append(a,o(e[a]));return fetch("/api/",{method:"POST",body:n}).then(e=>e.json()).catch(e=>{console.log({error:e.message}),"NetworkError when attempting to fetch resource."==e.message?error("Network Disconnected"):"JSON.parse: unexpected character at line 1 column 1 of the JSON data"==e.message&&error("Could Not Handle Request")}).then(r=>{if(200!=r.code&&error(r.msg),""!=r.rethrow)return r;post(e,!0)})}var i=nu("form",{id:"api-form",action:"/api/",method:"POST"});for(var a in e)nu("input",{type:"hidden",name:a,value:o(e[a])},i);nu("input",{type:"submit",style:"visibility: hidden;"},[i,document.body],!0).click(),nu("api-form").remove()}async function heartbeat(){"NetworkError when attempting to fetch resource."==(await post({ping:""})).message?error("Network Disconnected"):error(!1)}function error(e){"string"==typeof e?(added_at=Date.now(),nu("error").style.display="block",nu("error").innerText=e):Date.now()>added_at+api_wait&&(nu("error").style.display="none",nu("error").innerText="")}
function lock(e){e.preventDefault();var o=prompt("Re-enter password to lock");o&&post({lock:o},!0)}function save(e){e.preventDefault();var o=prompt("Re-enter password to save");o&&post({save:o}).then(e=>{200==e.code&&error("Cache was successfully saved")})}
function nu(e,n,t,r){if(!n)return document.getElementById(e);let o=document.createElement(e);if(n)for(const e in n)o[e]=n[e];let d=o;if(t){let e=[];Array.isArray(t)?e=t:e.push(t),e.forEach((function(e){var n;(n=e)instanceof HTMLElement?o=n.appendChild(o).parentNode:"string"==typeof n&&(o=document.getElementById(n).appendChild(o).parentNode)}))}return r?d:o}
const setting={button:function(e){const o=e.innerText.toLowerCase()||e.id;if("change password"==o){const e=prompt("Enter old password");if(!e)return;const o=prompt("Enter new password");if(!o)return;post({"change pwd":{old:e,new:o}})}else if("generate new key"==o){if(!confirm("Are you sure? Generating new key will make your friends unable to talk to you until your new public key is sent out"))return;const e=prompt("Enter password to confirm");if(!e)return;post({"new key":e},!0)}else if("devmode"==o)post({devmode:e.className.includes("-unchecked")}).then(()=>{window.location.reload(!0)});else if("nuke cache"==o){if(!confirm("Are you sure you want to delete cache?"))return;const e=prompt("Enter password to confirm");if(!e)return;post({nuke:e},!0)}else"fresh js"==o&&post({"fresh js":e.className.includes("-unchecked")}).then(()=>{window.location.reload(!0)})},dropdown:function(e){const o=e.attributes["data-type"].value;"EXPIRATION TIMER"==o?post({"expiration timer":e.value}):"MSG DELETION"==o?post({"msg policy":e.value}):"THEME"==o&&post({theme:e.value}).then(()=>{window.location.reload(!0)})}};
var tray=nu("tray"),friends=[];async function check_friends(){friends.length||(friends=(friends=await post({data:"friends"})).msg)}function realname(e){for(var n of friends)if(n.id==e)return n.name}function uname(e){for(var n of friends)if(n.name==e)return n.id}async function reload_msgs(){await check_friends();var e,n=document.cookie.replace(/(?:(?:^|.*;\s*)uname\s*\=\s*([^;]*).*$)|^.*$/,"$1");if(preload?(e=preload,preload=!1):e=(e=await post({data:{allfor:n}})).msg,0!=e.length){var a=e.id,i=e.msgs;i.length?(replace_template(new_card(e.hash,realname(n),"",!0,!0),nu("span",{className:"center name point",innerText:"RELOAD",id:"reload",onclick:()=>reload_msgs()}),i,e=>{var n=nu("span",{className:e.sending?"x-sending":"x-receiving",innerText:"x",onclick:()=>{post({status:""}).then(n=>{var i=void 0;if(0==n.msg["msg policy"]){if(!confirm("Are you sure you want to delete this message?"))return}else if(1==n.msg["msg policy"]){if(!(i=prompt("Enter Password")))return}else if(2!=n.msg["msg policy"])return;post({"delete msg":{id:a,index:e.index,pwd:i}}),reload_msgs()})}},nu("li",{className:"item"}));return nu("span",{className:"msg",innerText:e.msg},[nu("div",{className:"holder block "+(e.sending?"sending":"receiving")}),n]),n}),nu("reload").scrollIntoView()):replace_template(new_card(e.hash,realname(n),"",!0,!0).outerHTML+blank("Say hi to "+realname(n)+"!"),nu("span",{className:"center name point",id:"reload",innerText:"RELOAD",onclick:()=>reload_msgs()}))}}async function reload_index(){var e;await check_friends(),preload?(e=preload,preload=!1):e=(e=await post({data:"recent"})).msg,e.length?replace_template(void 0,nu("span",{className:"center name point",id:"reload",innerText:"RELOAD",onclick:()=>reload_index()}),e,e=>new_card(e.hash,realname(e.id),e.msgs[e.msgs.length-1].msg,!0,!1,!0)):replace_template(blank("Add a friend to start talking!"),nu("span",{className:"center name point",id:"reload",innerText:"RELOAD",onclick:()=>reload_index()}))}async function replace_template(e,n,a,i){tray.innerHTML='<div class="rightbar"><a class="rightitem name point" href="/add">ADD FRIEND</a><br><a class="rightitem name point" href="/account">ACCOUNT</a><br><span class="rightitem name point" onclick="save(event)">SAVE</span></div>',"string"==typeof e?tray.innerHTML+=e:e&&tray.appendChild(e),a&&a.forEach((e,n)=>{e.index=n,tray.appendChild(i(e))}),"string"==typeof n?tray.innerHTML+=n:n&&tray.appendChild(n)}function new_card(e,n,a,i=!1,r=!0,t=!1){var s=nu("ol",{});s.appendChild(nu("li",{className:"name title hide",innerText:n})),s.appendChild(nu("li",{className:"msg hide",innerText:a}));var l=nu("div",{className:t?"holder point":"holder"});r||(l.onclick=()=>window.location.href="/@"+uname(n)),l.appendChild(nu("img",{src:new_img(e),alt:n+"'s profile img"})),l.appendChild(document.createTextNode("\n")),l.appendChild(s);var d=nu("li",{className:"item"});if(d.appendChild(l),i)return d;tray.appendChild(d)}function new_img(e){var n=nu("canvas",{width:16,height:16}),a=n.getContext("2d"),i="";for(let n of e){var r=parseInt(n,16).toString(2);i+="0".repeat(4-r.length)+r}for(let e=0;e<256;e++)a.fillStyle="1"==i[e]?"rgb(255,255,255)":"rgb(0,0,0)",a.fillRect(e%16,~~(e/16),1,1);return n.toDataURL()}function blank(e){return`<div class="holder nopoint blank"><span class="title center">${e}</span></div>`}
function url(t){history.replaceState({},"","/"+t)}
