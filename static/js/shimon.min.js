//api.js
var added_at=0;async function post(e,r){error(!1);var t=document.cookie.replace(/(?:(?:^|.*;\s*)session\s*\=\s*([^;]*).*$)|^.*$/,"$1");t&&(e.session=t),e.redirect=!!r;var o=e=>{if("object"==typeof e)try{return JSON.stringify(e)}catch{}return e};if(!r){var n=new FormData;for(var a in e)n.append(a,o(e[a]));return fetch("/api/",{method:"POST",body:n}).then(e=>e.json()).catch(e=>{console.log({error:e.message}),"NetworkError when attempting to fetch resource."==e.message?error("Network Disconnected"):"JSON.parse: unexpected character at line 1 column 1 of the JSON data"==e.message&&error("Could Not Handle Request")}).then(r=>{if(200!=r.code&&error(r.msg),""!=r.rethrow)return r;post(e,!0)})}var i=nu("form",{id:"api-form",action:"/api/",method:"POST"});for(var a in e)nu("input",{type:"hidden",name:a,value:o(e[a])},i);nu("input",{type:"submit",style:"visibility: hidden;"},[i,document.body],!0).click(),nu("api-form").remove()}async function heartbeat(){"NetworkError when attempting to fetch resource."==(await post({ping:""})).message?error("Network Disconnected"):error()}function error(e){e?(added_at=Date.now(),nu("error").style.display="block",nu("error").innerText=e):Date.now()>added_at+5e3&&(nu("error").style.display="none",nu("error").innerText="")}

//lock.js
function lock(e){e.preventDefault();var o=prompt("Re-enter password to lock");o&&post({lock:o},!0)}function save(e){e.preventDefault();var o=prompt("Re-enter password to save");o&&post({save:o}).then(e=>{200==e.code&&error("Cache was successfully saved")})}

//msg.js
async function send(e){"Enter"==e.key&&e.target.value&&(await post({"send msg":{uname:document.cookie.replace(/(?:(?:^|.*;\s*)uname\s*\=\s*([^;]*).*$)|^.*$/,"$1"),msg:e.target.value}}).then(e=>{400!=e.code&&reload_msgs()}),e.target.value="")}

//nu.min.js
function nu(n,e,r,t){if(!e)return document.getElementById(n);var a=document.createElement(n);if(e)for(var i in e)a[i]=e[i];var d=a;function o(n){var e=n.constructor.name;"HTML"==e.substring(0,4)?a=n.appendChild(a).parentNode:"String"==e&&(a=document.getElementById(n).appendChild(a).parentNode)}if(o.bind(this),r){var u=[];Array.isArray(r)?u=r:u.push(r),u.forEach((function(n){o(n)}))}return t?d:a}

//settings.js
function setting(e){var t=e.attributes["data-type"];t&&(t=t.value);var r=e.innerText.toLowerCase()||e.id;if("change password"==r){var o=prompt("Enter old password");if(!o)return;var n=prompt("Enter new password");if(!n)return;post({"change pwd":{old:o,new:n}})}else if("generate new key"==r){if(!confirm("Are you sure? Generating new key will make your friends unable to talk to you until your new public key is sent out"))return;if(!(i=prompt("Enter password to confirm")))return;post({"new key":i},!0)}else if("EXPIRATION TIMER"==t)post({"expiration timer":e.value});else if("MSG DELETION"==t)post({"msg policy":e.value});else if("THEME"==t)post({theme:e.value}).then(e=>{window.location.reload(!0)});else if("ENABLE DEVELOPER MODE"==t)post({devmode:e.className.includes("-unchecked")}).then(e=>{window.location.reload(!0)});else if("nuke cache"==r){if(!confirm("Are you sure you want to delete cache?"))return;var i;if(!(i=prompt("Enter password to confirm")))return;post({nuke:i},!0)}}

//ui.js
var tray=nu("tray"),friends=[];async function check_friends(){friends.length||(friends=(friends=await post({data:"friends"})).msg)}function realname(e){for(var n of friends)if(n.id==e)return n.name}function uname(e){for(var n of friends)if(n.name==e)return n.id}async function reload_msgs(){await check_friends();var e=document.cookie.replace(/(?:(?:^|.*;\s*)uname\s*\=\s*([^;]*).*$)|^.*$/,"$1");if(preload){n=preload;preload=!1}else{var n;n=(n=await post({data:{allfor:e}})).msg}if(0!=n.length){var a=n.id,i=n.msgs;i.length?(replace_template(new_card(n.hash,realname(e),"",!0,!0),nu("span",{className:"center name point",innerText:"RELOAD",id:"reload",onclick:()=>reload_msgs()}),i,e=>{var n=nu("span",{className:e.sending?"x-sending":"x-receiving",innerText:"x",onclick:n=>{post({status:""}).then(n=>{var i=void 0;if(0==n.msg["msg policy"]){if(!confirm("Are you sure you want to delete this message?"))return}else if(1==n.msg["msg policy"]){if(!(i=prompt("Enter Password")))return}else if(2!=n.msg["msg policy"])return;post({"delete msg":{id:a,index:e.index,pwd:i}}),reload_msgs()})}},nu("li",{className:"item"}));return nu("span",{className:"msg",innerText:e.msg},[nu("div",{className:"holder block "+(e.sending?"sending":"receiving")}),n]),n}),nu("reload").scrollIntoView()):replace_template(new_card(n.hash,realname(e),"",!0,!0).outerHTML+blank("Say hi to "+realname(e)+"!"),nu("span",{className:"center name point",id:"reload",innerText:"RELOAD",onclick:()=>reload_msgs()}))}}async function reload_index(){if(await check_friends(),preload){e=preload;preload=!1}else{var e;e=(e=await post({data:"recent"})).msg}e.length?replace_template(void 0,nu("span",{className:"center name point",id:"reload",innerText:"RELOAD",onclick:()=>reload_index()}),e,e=>new_card(e.hash,realname(e.id),e.msgs[e.msgs.length-1].msg,!0,!1,!0)):replace_template(blank("Add a friend to start talking!"),nu("span",{className:"center name point",id:"reload",innerText:"RELOAD",onclick:()=>reload_index()}))}async function replace_template(e,n,a,i){tray.innerHTML='<div class="rightbar"><a class="rightitem name point" href="/add">ADD FRIEND</a><br><a class="rightitem name point" href="/account">ACCOUNT</a><br><span class="rightitem name point" onclick="save(event)">SAVE</span></div>',"string"==typeof e?tray.innerHTML+=e:e&&tray.appendChild(e),a&&a.forEach((e,n)=>{e.index=n,tray.appendChild(i(e))}),n&&tray.appendChild(n)}function new_card(e,n,a,i,r,t){var s=nu("ol",{});s.appendChild(nu("li",{className:"name title hide",innerText:n})),s.appendChild(nu("li",{className:"msg hide",innerText:a}));var l=nu("div",{className:t?"holder point":"holder"});r||(l.onclick=()=>window.location="/msg/"+uname(n)),l.appendChild(nu("img",{src:new_img(e)})),l.appendChild(document.createTextNode("\n")),l.appendChild(s);var d=nu("li",{className:"item"});if(d.appendChild(l),i)return d;tray.appendChild(d)}function new_img(e){var n=nu("canvas",{width:16,height:16}),a=n.getContext("2d"),i="";for(var r of e){var t=parseInt(r,16).toString(2);i+="0".repeat(4-t.length)+t}for(r=0;r<256;r++)a.fillStyle="1"==i[r]?"rgb(255,255,255)":"rgb(0,0,0)",a.fillRect(r%16,~~(r/16),1,1);return n.toDataURL()}function blank(e){return`<div class="holder nopoint blank"><span class="title center">${e}</span></div>`}

//url.js
function url(t){history.replaceState({},"","/"+t)}
