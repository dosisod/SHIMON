//api.js
async function post(arr,redirect){document.getElementById("error").innerText="";session=document.cookie.replace(/(?:(?:^|.*;\s*)session\s*\=\s*([^;]*).*$)|^.*$/,"$1");if(session){arr["session"]=session}arr["redirect"]=!!redirect;var encode=(s)=>{if(typeof s=="object"){try{return JSON.stringify(s)}catch{}}return s};if(redirect){var form=nu("form",{"id":"api-form","action":"/api/","method":"POST"});for(i in arr){nu("input",{"type":"hidden","name":i,"value":encode(arr[i])},form)}var submit=nu("input",{"type":"submit","style":"visibility: hidden;"},[form,document.body],true);submit.click();document.getElementById("api-form").remove()}else{var fd=new FormData();for(i in arr){fd.append(i,encode(arr[i]));}return fetch("/api/",{method:"POST",body:fd}).then(e=>e.json()).catch(e=>{console.log({"error":e.message});if(e.message=="NetworkError when attempting to fetch resource."){document.getElementById("error").style.display="block";document.getElementById("error").innerText="Network Disconnected"}}).then(e=>{if(e["code"]!=200){document.getElementById("error").style.display="block";document.getElementById("error").innerText=e["msg"]};if(e["rethrow"]==""){post(arr,true)}else{return e;}})}}

//lock.js
function lock(e){e.preventDefault();str=prompt("Re-enter password to lock");if(!str){return;}post({"lock":str},true)}function save(e){e.preventDefault();str=prompt("Re-enter password to save");if(!str){return}post({"save":str}).then(e=>{if(e["code"]==200){document.getElementById("error").style.display="block";document.getElementById("error").innerText="Cache was successfully saved"}})}

//nu.min.js
function nu(n,a,p,k){h=document.createElement(n);if(a)for(i in a)h[i]=a[i];o=h;f=e=>{t=e.constructor.name;if(t.substring(0, 4)=="HTML")h=e.appendChild(h).parentNode;else if(t=="String")h=document.getElementById(e).appendChild(h).parentNode};if(p){l=[];if(!Array.isArray(p))l.push(p);else l=p;l.forEach(e=>f(e))}return k?o:h}

//settings.js
function setting(e){str=e.innerText.toLowerCase()||e.id;if(str=="change password"){old=prompt("Enter old password");if(!old){return}nw=prompt("Enter new password");if(!nw){return}post({"change pwd":{"old":old,"new":nw}})}else if(str=="generate new key"){if(!confirm("Are you sure? Generating new key will make your friends unable to talk to you until your new public key is sent out")){return}pwd=prompt("Enter password to confirm");if(!pwd){return}post({"new key":pwd},true)}else if(["15 mins","1 hour","5 hours","1 day"].indexOf(str)>-1){post({"expiration timer":e.value})}else if(str=="darkmode"){post({"darkmode":e.checked}).then(e=>{window.location.reload(true)});}else if(str=="devmode"){post({"devmode":e.checked}).then(e=>{window.location.reload(true)});}else if(str=="nuke cache"){if(!confirm("Are you sure you want to delete cache?")){return;}pwd=prompt("Enter password to confirm");if(!pwd){return}post({"nuke":pwd},true)}}

//ui.js
var tray=document.getElementById("tray");var friends=[];async function check_friends(){if(!friends.length){friends=await post({"data":"friends"});friends=friends["msg"]}}function realname(id){for(i of friends){if(i["id"]==id){return i["name"]}}}function uname(name){for(i of friends){if(i["name"]==name){return i["id"]}}}async function reload_msgs(){await check_friends();user=document.cookie.replace(/(?:(?:^|.*;\s*)uname\s*\=\s*([^;]*).*$)|^.*$/,"$1");raw=await post({"data":{"allfor":user}});raw=raw["msg"];if(raw.length==0)return;rawid=raw["id"];data=raw["msgs"];replace_template(new_card(raw["hash"],realname(user),"",true,true ),(arr)=>{ret=nu("span",{"className":arr["sending"]?"x-sending":"x-receiving","innerText":"x","onclick":(e)=>{if(!confirm("Are you sure you want to delete this message?")){return}post({"delete msg":{"id":rawid,"index":arr["index"]}});reload_msgs()}},nu("li",{"className":"item"}));nu("span",{"className":"msg","innerText":arr["msg"]},[nu("div",{"className":"holder block "+(arr["sending"]?"sending":"receiving")}),ret]);return ret},data,nu("span",{"className":"center name point","innerText":"RELOAD","id":"reload","onclick":()=>reload_msgs()}))}async function reload_index(){await check_friends();raw=await post({"data":"recent"});raw=raw["msg"];replace_template(undefined,(arr)=>{return new_card(arr["hash"],realname(arr["id"]),arr["msgs"][arr["msgs"].length-1]["msg"],true,false,true)},raw,nu("span",{"className":"center name point","innerText":"RELOAD","onclick":()=>reload_index()}))}async function replace_template(start,template,params,end){tray.innerHTML=`<div class="rightbar"><a class="rightitem name point" href="/add">ADD FRIEND</a><br><a class="rightitem name point" href="/account">ACCOUNT</a><br><span class="rightitem name point" onclick="save(event)">SAVE</span></div>`;if(start){tray.appendChild(start)}params.forEach((e,i)=>{e["index"]=i;tray.appendChild(template(e))});if(end){tray.appendChild(end)}}function new_card(u,n,m,r,d,p){var ol=nu("ol");ol.appendChild(nu("li",{"className":"name hide","innerText":n}));ol.appendChild(nu("li",{"className":"msg hide","innerText":m}));var div=nu("div",{"className":p?"holder point":"holder"});if(!d){div.onclick=()=>window.location="/msg/"+uname(n)}div.appendChild(nu("img",{"src":new_img(u)}));div.appendChild(document.createTextNode("\n"));div.appendChild(ol);var card=nu("li",{"className":"item"});card.appendChild(div);if(r){return card;}tray.appendChild(card);}function new_img(uuid){var canv=nu("canvas",{"width":16,"height":16});var draw=canv.getContext("2d");bin="";for(i of uuid){tmp=parseInt(i,16).toString(2);bin+="0".repeat(4-tmp.length)+tmp}for(i=0;i<256;i+=1){draw.fillStyle=(bin[i]=="1")?"rgb(255,255,255)":"rgb(0,0,0)";draw.fillRect(i%16,~~(i/16),1,1);}return canv.toDataURL()}

//url.js
function url(s){history.replaceState({},"","/"+s)}
