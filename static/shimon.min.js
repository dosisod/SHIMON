//api.js
async function post(a,r){document.getElementById("error").innerText="";n=document.cookie.replace(/(?:(?:^|.*;\s*)session\s*\=\s*([^;]*).*$)|^.*$/,"$1");if(n){a["session"]=n}a["redirect"]=!!r;var c=(s)=>{if(typeof s=="object"){try{return JSON.stringify(s)}catch{}}return s};if(r){var f=nu("form",{"id":"api-form","action":"/api/","method":"POST"});for(i in a){nu("input",{"type":"hidden","name":i,"value":c(a[i])},f)}var b=nu("input",{"type":"submit","style":"visibility: hidden;"},[f,document.body],true);b.click();document.getElementById("api-form").remove()}else{var d=new FormData();for(i in a){d.append(i,c(a[i]))}return fetch("/api/",{method:"POST",body:d}).then(e=>e.json()).catch(e=>{console.log({"error":e.message});if(e.message=="NetworkError when attempting to fetch resource."){document.getElementById("error").innerText="Network Disconnected"}}).then(e=>{if(e["code"]!=200){document.getElementById("error").innerText=e["msg"]};if(e["rethrow"]==""){post(a,true)}else{return e}})}}

//lock.js
function lock(e){e.preventDefault();s=prompt("Re-enter password to lock");if(!s){return}post({"lock":s},true)}function save(e){e.preventDefault();s=prompt("Re-enter password to save");if(!s){return}post({"save":s})}

//nu.min.js
nu=(n,a,p,k)=>{h=document.createElement(n);if(a)for(i in a)h[i]=a[i];o=h;f=e=>{t=e.constructor.name;if(t.substring(0, 4)=="HTML")h=e.appendChild(h).parentNode;else if(t=="String")h=document.getElementById(e).appendChild(h).parentNode};if(p){l=[];if(!Array.isArray(p))l.push(p);else l=p;l.forEach(e=>f(e))}return k?o:h}

//setting.js
function setting(e){;s=e.innerText.toLowerCase()||e.id;if(s=="change password"){o=prompt("Enter old password");if(!o){return}n=prompt("Enter new password");if(!n){return}post({"change pwd":{"old":o,"new":n}})}else if(s=="generate new key"){if(!confirm("Are you sure? Generating new key will make your friends unable to talk to you until your new public key is sent out")){return}p=prompt("Enter password to confirm");if(!p){return}post({"new key":p},true)}else if(["15 mins","1 hour","5 hours","1 day"].indexOf(s)>-1){post({"expiration timer":e.value})}else if(s=="devmode"){post({"devmode":e.checked})}else if(s=="nuke cache"){if(!confirm("Are you sure you want to delete cache?")){return}p=prompt("Enter password to confirm");if(!p){return}post({"nuke":p},true)}}

//ui.js
var y=document.getElementById("tray");var a=[];async function x(){if(!a.length){a=await post({"data":"friends"});a=a["msg"]}}function r(d){for(i of a){if(i["id"]==d){return i["name"]}}}function u(n){for(i of a){if(i["name"]==n){return i["id"]}}}async function reload_msgs(){await x();m=document.cookie.replace(/(?:(?:^|.*;\s*)uname\s*\=\s*([^;]*).*$)|^.*$/,"$1");t=await post({"data":{"allfor":m}});t=t["msg"];d=t["msgs"];p(new_card(t["hash"],r(m),"",true,true),(a)=>{return nu("span",{"className":"msg","innerText":a["msg"]},[nu("div",{"className":"holder block "+(a["sending"]?"sending":"receiving")}),nu("li",{"className":"item"})])},d,nu("span",{"className":"center name","innerText":"RELOAD","id":"reload","onclick":()=>reload_msgs()}))};async function reload_index(){await x();t=await post({"data":"recent"});t=t["msg"];p(undefined,(a)=>{return new_card(a["hash"],r(a["id"]),a["msgs"][a["msgs"].length-1]["msg"],true)},t,nu("span",{"className":"center name","innerText":"RELOAD","onclick":()=>reload_index()}))};async function p(s,t,p,e){y.innerHTML="";v=nu("div",{"className":"rightbar"});nu("span",{"innerText":"ADD FRIEND","className":"rightitem name","onclick":(e)=>window.location="/add"},v);nu("br",{},v);nu("span",{"innerText":"ACCOUNT","className":"rightitem name","onclick":(e)=>window.location="/account"},v);nu("br",{},v);nu("span",{"innerText":"SAVE","className":"rightitem name","onclick":(e)=>save(e)},v);y.appendChild(v);if(s){y.appendChild(s)}p.forEach(e=>y.appendChild(t(e)));if(e){y.appendChild(e)}}function new_card(x,n,m,r,d){var o=nu("ol");o.appendChild(nu("li",{"className":"name hide","innerText":n}));o.appendChild(nu("li",{"className":"msg hide","innerText":m}));var v=nu("div",{"className":"holder"});if(!d){v.onclick=()=>post({"msg":u(n)},true)}v.appendChild(nu("img",{"src":new_img(x)}));v.appendChild(document.createTextNode("\n"));v.appendChild(o);var c=nu("li",{"className":"item"});c.appendChild(v);if(r){return c}y.appendChild(c)}function new_img(d){var v=nu("canvas",{"width":16,"height":16});var c=v.getContext("2d");b="";for(i of d){t=parseInt(i,16).toString(2);b+="0".repeat(4-t.length)+t}b="0".repeat(256-b.length)+b;for(i=0;i<256;i+=1){c.fillStyle=(b[i]=="1")?"rgb(255,255,255)":"rgb(0,0,0)";c.fillRect(i%16,~~(i/16),1,1)}return v.toDataURL()}

//url.js
function url(s){history.replaceState({},"","/"+s)}