//api.js
async function post(e,t){document.getElementById("error").innerText="";var r=document.cookie.replace(/(?:(?:^|.*;\s*)session\s*\=\s*([^;]*).*$)|^.*$/,"$1");r&&(e.session=r),e.redirect=!!t;var n=e=>{if("object"==typeof e)try{return JSON.stringify(e)}catch{}return e};if(!t){var o=new FormData;for(var i in e)o.append(i,n(e[i]));return fetch("/api/",{method:"POST",body:o}).then(e=>e.json()).catch(e=>{console.log({error:e.message}),"NetworkError when attempting to fetch resource."==e.message&&(document.getElementById("error").style.display="block",document.getElementById("error").innerText="Network Disconnected")}).then(t=>{if(200!=t.code&&(document.getElementById("error").style.display="block",document.getElementById("error").innerText=t.msg),""!=t.rethrow)return t;post(e,!0)})}var c=nu("form",{id:"api-form",action:"/api/",method:"POST"});for(var i in e)nu("input",{type:"hidden",name:i,value:n(e[i])},c);nu("input",{type:"submit",style:"visibility: hidden;"},[c,document.body],!0).click(),document.getElementById("api-form").remove()}

//lock.js
function lock(e){e.preventDefault();var t=prompt("Re-enter password to lock");t&&post({lock:t},!0)}function save(e){e.preventDefault();var t=prompt("Re-enter password to save");t&&post({save:t}).then(e=>{200==e.code&&(document.getElementById("error").style.display="block",document.getElementById("error").innerText="Cache was successfully saved")})}

//nu.min.js
function nu(n,r,e,t){var a=document.createElement(n);if(r)for(var i in r)a[i]=r[i];var o=a;function d(n){var r=n.constructor.name;"HTML"==r.substring(0,4)?a=n.appendChild(a).parentNode:"String"==r&&(a=document.getElementById(n).appendChild(a).parentNode)}if(d.bind(this),e){var u=[];Array.isArray(e)?u=e:u.push(e),u.forEach((function(n){d(n)}))}return t?o:a}

//settings.js
function setting(e){var t=e.attributes["data-type"];t&&(t=t.value);var r=e.innerText.toLowerCase()||e.id;if("change password"==r){var o=prompt("Enter old password");if(!o)return;var n=prompt("Enter new password");if(!n)return;post({"change pwd":{old:o,new:n}})}else if("generate new key"==r){if(!confirm("Are you sure? Generating new key will make your friends unable to talk to you until your new public key is sent out"))return;if(!(i=prompt("Enter password to confirm")))return;post({"new key":i},!0)}else if("EXPIRATION TIMER"==t)post({"expiration timer":e.value});else if("MSG DELETION"==t)post({"msg policy":e.value});else if("THEME"==t)post({theme:e.value}).then(e=>{window.location.reload(!0)});else if("devmode"==r)post({devmode:e.checked}).then(e=>{window.location.reload(!0)});else if("nuke cache"==r){if(!confirm("Are you sure you want to delete cache?"))return;var i;if(!(i=prompt("Enter password to confirm")))return;post({nuke:i},!0)}}

//ui.js
var tray=document.getElementById("tray"),friends=[];async function check_friends(){friends.length||(friends=(friends=await post({data:"friends"})).msg)}function realname(e){for(var n of friends)if(n.id==e)return n.name}function uname(e){for(var n of friends)if(n.name==e)return n.id}async function reload_msgs(){await check_friends();var e=document.cookie.replace(/(?:(?:^|.*;\s*)uname\s*\=\s*([^;]*).*$)|^.*$/,"$1");if(preload){n=preload;preload=!1}else{var n;n=(n=await post({data:{allfor:e}})).msg}if(0!=n.length){var a=n.id,i=n.msgs;replace_template(new_card(n.hash,realname(e),"",!0,!0),e=>{var n=nu("span",{className:e.sending?"x-sending":"x-receiving",innerText:"x",onclick:n=>{post({status:""}).then(n=>{var i=void 0;if(0==n.msg["msg policy"]){if(!confirm("Are you sure you want to delete this message?"))return}else if(1==n.msg["msg policy"]){if(!(i=prompt("Enter Password")))return}else if(2!=n.msg["msg policy"])return;post({"delete msg":{id:a,index:e.index,pwd:i}}),reload_msgs()})}},nu("li",{className:"item"}));return nu("span",{className:"msg",innerText:e.msg},[nu("div",{className:"holder block "+(e.sending?"sending":"receiving")}),n]),n},i,nu("span",{className:"center name point",innerText:"RELOAD",id:"reload",onclick:()=>reload_msgs()}))}}async function reload_index(){if(await check_friends(),preload){e=preload;preload=!1}else{var e;e=(e=await post({data:"recent"})).msg}replace_template(void 0,e=>new_card(e.hash,realname(e.id),e.msgs[e.msgs.length-1].msg,!0,!1,!0),e,nu("span",{className:"center name point",innerText:"RELOAD",onclick:()=>reload_index()}))}async function replace_template(e,n,a,i){tray.innerHTML='<div class="rightbar"><a class="rightitem name point" href="/add">ADD FRIEND</a><br><a class="rightitem name point" href="/account">ACCOUNT</a><br><span class="rightitem name point" onclick="save(event)">SAVE</span></div>',e&&tray.appendChild(e),a.forEach((e,a)=>{e.index=a,tray.appendChild(n(e))}),i&&tray.appendChild(i)}function new_card(e,n,a,i,r,s){var t=nu("ol");t.appendChild(nu("li",{className:"name hide",innerText:n})),t.appendChild(nu("li",{className:"msg hide",innerText:a}));var d=nu("div",{className:s?"holder point":"holder"});r||(d.onclick=()=>window.location="/msg/"+uname(n)),d.appendChild(nu("img",{src:new_img(e)})),d.appendChild(document.createTextNode("\n")),d.appendChild(t);var l=nu("li",{className:"item"});if(l.appendChild(d),i)return l;tray.appendChild(l)}function new_img(e){var n=nu("canvas",{width:16,height:16}),a=n.getContext("2d"),i="";for(var r of e){var s=parseInt(r,16).toString(2);i+="0".repeat(4-s.length)+s}for(r=0;r<256;r++)a.fillStyle="1"==i[r]?"rgb(255,255,255)":"rgb(0,0,0)",a.fillRect(r%16,~~(r/16),1,1);return n.toDataURL()}

//url.js
function url(t){history.replaceState({},"","/"+t)}
